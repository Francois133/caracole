{% extends 'layout.html' %}
{% load floreal_filters %}
{% load static %}

{% block head %}
  <script type='text/javascript'>
  // <![CDATA[

    var PRODUCT_IDS=[{% for pd in products %}{{pd.id}},{% endfor %}];
    var PRODUCT_WEIGHTS=[{% for pd in products %}{{pd.unit_weight}},{% endfor %}];
    var PURCHASES=[{% for pc in purchases %}
      {'product': {{pc.product.id}}, 'ordered': {{pc.ordered}} },
    {% endfor %}];

    /* update per-line totals as well as delivery total */
    function update_weight_and_prices() {
      var total_price = 0;
      var total_weight = 0;
      for(var i=0; i<PRODUCT_IDS.length; i++) {
        var pd_id = PRODUCT_IDS[i];
        var ordered = parseFloat($("#pd"+pd_id+"-ordered_quantity").attr("value"));
        var unit_price = parseFloat($("#pd"+pd_id+"-unit_price").text().replace(',','.'));
        var price = ordered * unit_price
        $("#pd"+pd_id+"-ordered_price").text(price.toFixed(2))
        total_price += price
        total_weight += ordered * PRODUCT_WEIGHTS[i];
        console.log(pd_id + " -> " + ordered + " * " + unit_price + " = " + price + " -> Σ=" + total_price);
      }
      $("#total_price").text(total_price.toFixed(2));
      $("#total_weight").text(total_weight.toFixed(0));
    }

    function reset_order(id) {
      $("#pd"+id+"-ordered_quantity").attr("value", "0");
      update_weight_and_prices();
    }

    $(document).ready(function() {
      /* Set purchases */
      for(var i=0; i<PURCHASES.length; i++) {
        var pc = PURCHASES[i];
        $("#pd"+pc.product+"-ordered_quantity").attr("value", pc.ordered)
      }
      $(":input").bind('keyup mouseup', update_weight_and_prices);
      update_weight_and_prices();
    })
  // ]]>
  </script>
  <style type="text/css">
    input.quantity { text-align: right; }
	.total_cell { font-weight: bold; }
    .product-name { text-align: right; }
    .product-unit { text-align: left; }
    .unit-price { padding-left: 10px; }
  </style>
{% endblock %}

{% block content %}
<form method="POST">
    <table id="delivery-table">
      <tr>
        <th>Livraison :</th>
        <td>{{delivery.network.name}} / {{delivery.name}}</td>
      </tr>
      <tr>
        <th>Sous-groupe :</th>
        <td>{{subgroup.name}}</td>
      </tr>
      <tr>
        <th>Member :</th>
        <td>{{user.first_name}} {{user.last_name}}</td>
      </tr>
    </table>
    <div style="height: 20px;"></div>
    <table id="products-table">
        <tr>
            <th>Produit</th>
            <th>Quantité</th>
            <th></th>
            <th>Prix unitaire</th>
            <th>Prix</th>
            <th>Conditionnement</th>
            <th>Effacer ?</th>
        </tr>
        {% for pd in products %}
        <tr>
          <td class="product-name">{{pd.name}}</td>
          <td><input class="quantity" id="pd{{pd.id}}-ordered_quantity" maxlength="64" name="pd{{pd.id}}" type="number" step="1" min="0" value="0" /></td>
          <td class="product-unit">{{pd.unit}}</td>
          <td class="unit-price"><span id="pd{{pd.id}}-unit_price">{{pd.price|price_nocurrency}}</span> €/{{pd.unit}}</td>
          <td><span id="pd{{pd.id}}-ordered_price">-</span> €</td>
          <td>{% if pd.quantity_per_package %}{{pd.quantity_per_package}} {{pd.unit}}/carton{% else %} - {% endif %}</td>
          <td><input type="image" src={% static 'images/minus.png' %} onclick="reset_order({{pd.id}}); return false" value="Remettre à 0"></td>
        </tr>
        {% endfor %}
        <tr>
        <td colspan="3"></td>
        <th>Prix total:</th><td class="total_cell"><span id="total_price">-</span>&nbsp;€</td>
        <td colspan="2"></td>
        </tr>
        <tr>
        <td colspan="3"></td>
        <th>Poids total:</th><td class="total_cell"><span id="total_weight">-</span>&nbsp;kg</td>
        <td colspan="2"></td>
        </tr>
    </table>
    <input type="submit" value="Sauvegarder" />
    <input type='hidden' name='dv-id' value='{{delivery.id}}' />
    {% csrf_token %}
</form>
{% endblock %}
